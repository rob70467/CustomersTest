@page
@using CommonModels
@model CustomersUI.Pages.Customers.CustomerListModel
@{
    ViewData["Title"] = "Customers";
}

@* <div class="text-center"> *@
<div>
    <div>
        <button id="addCustomerBtn" class="btn btn-primary" onclick="loadCustomerDetails(0)">Add New Customer</button>
    </div>
    <div>
        @if (Model.Customers.Any())
        {
            <table class="customerTable">
                <thead>
                <tr>
                    <th>
                        @Html.DisplayNameFor(model => model.Customers[0].Name)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Customers[0].Reference)
                    </th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                @foreach (var customer in Model.Customers)
                {
                    <tr>
                        <td>
                            @customer.Name
                        </td>
                        <td>
                            @customer.Reference
                        </td>
                        <td>
                            <button class="btn btn-primary btn-edit editCustomerBtn" onclick="loadCustomerDetails(@customer.Id)">Edit</button>
                            <button class="btn btn-primary btn-edit deleteCustomerBtn" onclick="deleteCustomer(@customer.Id)">Delete</button>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
        else
        {
            <span>No Customers Found </span>
        }
    </div>
</div>

@Html.AntiForgeryToken()

@await Html.PartialAsync("_CustomerEdit", new Customer())

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function loadCustomerDetails(customerId) {
        $.ajax({
            url: '/Customers/CustomerList?handler=CustomerDetails',
            type: 'GET',
            data: { id: customerId },
            success: function (data) {
                $('#customerId').val(data.id);
                $('#customerName').val(data.name);
                $('#customerReference').val(data.reference);
                $('#customerModalLabel').text(data.id === 0 ? 'Add New Customer' : 'Edit Customer');
            
                $('#customerModal').modal('show');
            },
            error: function (err) {
                console.error("Error loading customer details:", err);
            }
        });
    }

    function isFormValid() {
        var nameInput = document.getElementById('customerName');
        var referenceInput = document.getElementById('customerReference');
        var nameError = document.getElementById('nameError');
        var referenceError = document.getElementById('referenceError');

        // Clear previous error messages
        nameError.style.display = 'none';
        referenceError.style.display = 'none';

        var isValid = true;

        // Validate name
        if (nameInput.value.trim() === '') {
            nameError.style.display = 'block';
            isValid = false;
        }

        // Validate reference
        if (referenceInput.value.trim() === '') {
            referenceError.style.display = 'block';
            isValid = false;
        }

        return isValid;
    }

    function saveCustomerDetails() {

        if (!isFormValid()) {
            return; 
        }
        
        var formData = $('#customerForm').serialize();
        var token = $('input[name="__RequestVerificationToken"]').val();

        $.ajax({
            url: '/Customers/CustomerList?handler=SaveCustomer',
            type: 'POST',
            data: formData + "&__RequestVerificationToken=" + token,
            success: function () {
                $('#customerModal').modal('hide');
                location.reload();
            },
            error: function (err) {
                alert("Error saving customer.");
                console.error("Error saving customer details:", err);
            }
        });
    }

    function deleteCustomer(customerId) {
        if (confirm("Are you sure you want to delete this customer?")) {

            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '/Customers/CustomerList?handler=DeleteCustomer',  
                type: 'POST',
                data: {
                    id: customerId,
                    __RequestVerificationToken: token
                },
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8', 
                success: function (result) {
                    location.reload(); 
                },
                error: function () {
                    alert("Error deleting customer.");
                    console.error("Error deleting customer details:", err);
                }
            });
        }
    }

</script>

